#!/bin/bash -ex

action="$1"
shift

llvm_config=""
libdir=""
cmake=""
make=""
link_mode=""
use_homebrew="false"

while [[ $# -gt 0 ]]; do
  case $1 in
  --llvm-config)
    if [[ $# -lt 2 ]]; then
        echo "No llvm-config specified."
        exit 1
    fi
    llvm_config="$2"
    shift 2
    ;;
  --libdir)
    if [[ $# -lt 2 ]]; then
        echo "No libdir specified."
        exit 1
    fi
    libdir="$2"
    shift 2
    ;;
  --cmake)
    if [[ $# -lt 2 ]]; then
        echo "No cmake specified."
        exit 1
    fi
    cmake="$2"
    shift 2
    ;;
  --make)
    if [[ $# -lt 2 ]]; then
        echo "No make specified."
        exit 1
    fi
    make="$2"
    shift 2
    ;;
  --link-mode)
    if [[ $# -lt 2 ]]; then
        echo "No link-mode specified."
        exit 1
    fi
    link_mode="$2"
    shift 2
    ;;
  --use-homebrew)
    use_homebrew="true"
    shift
    ;;
  *)
    echo "Unknown option."
    shift
    ;;
  esac
done

function filter_experimental_targets {
    sed 's/ARC//g' | sed 's/CSKY//g' | sed 's/DirectX//g' | sed 's/M68k//g' | sed 's/SPIRV//g' | sed 's/Xtensa//g' | xargs
}

function llvm_build {
    ocaml_flags="$($llvm_config --ldflags)"
    if [[ $use_homebrew = "true" ]]; then
        ocaml_flags="$ocaml_flags -L$(brew --prefix)/lib"
    fi

    mkdir "build"
    "$cmake" -Bbuild -Sllvm \
        -DCMAKE_BUILD_TYPE="$($llvm_config --build-mode)" \
        -DLLVM_TARGETS_TO_BUILD="$($llvm_config --targets-built | filter_experimental_targets | sed 's/ /;/g')" \
        -DLLVM_OCAML_LDFLAGS="$ocaml_flags" \
        -DLLVM_LINK_LLVM_DYLIB=$([ $link_mode = "shared" ] && echo TRUE || echo FALSE) \
        -DLLVM_OCAML_BUILD_CUSTOM=TRUE \
        -DLLVM_OCAML_OUT_OF_TREE=TRUE \
        -DLLVM_OCAML_INSTALL_PATH="$libdir"
    $make VERBOSE=1 -j -Cbuild ocaml_all
}

function llvm_install {
  if test -d "build"; then
    "$cmake" -Pbuild/bindings/ocaml/cmake_install.cmake
  fi
}

case "$action" in
"build")
  llvm_build
  ;;
"install")
  llvm_install
  ;;
*)
  echo "Action not recognized"
  exit 1
  ;;
esac
